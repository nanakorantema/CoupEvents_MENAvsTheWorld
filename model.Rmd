---
title: "model data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(infer)
library(tidyverse)
library(tidymodels)
library(rpart.plot)
library(rstanarm)
library(tidybayes)
library(gtsummary)
library(Rcpp)
library(gt)
library(scales)
```

```{r intial data}

coup_data <- read_csv(file = "Coup_Data/Coup_Data_v2.0.0.csv")



coup_data %>% 
  cols(
  .default = col_double(),
  coup_id = col_character(),
  country = col_character(),
  month = col_character(),
  day = col_character(),
  event_type = col_character()
)

model_data <- coup_data %>% 
                  select( - c(unrealized, conspiracy, attempt, coup_id, day, noharm)) %>%
                  group_by(year) %>% 
                  arrange(desc(year)) %>% 
                  filter(country %in% c("Algeria", "Kuwait", "Egypt", "Iran", "Iraq", "Israel", "Jordan", "Lebanon", "libya", "Morocco", "Oman", "Qatar", "Saudi Arabia", "Syria", "Tunisia", "Yemen"))

```

```{r fit_1}

fit_1 <- stan_glm(realized ~ popular + military + foreign + auto + country + event_type + killed,
                  family = "binomial",
                  model_data,
                  refresh = 0,
                  seed = 13)

print(fit_1, digits = 3)





```

```{r}

logistic_mod <- logistic_reg() %>% 
  set_engine("glm")

logistic_fit <- fit(logistic_mod,
                    realized ~ popular + military + foreign + auto + country + event_type + killed,
                    family = binomial,
                    data = model_data)

model_data$realized <- as_factor(model_data$realized)

country_a <- tibble(
  popular = 1,
  military = 0,
  foreign = 0,
  auto = 0,
  event_type = "coup",
  killed = 1 ,
  )

x <- predict(fit_1, new_data = country_a, type = "prob")

```

```{r}
Table_1 <- tbl_regression(fit_1, 
                           intercept = TRUE, 
                           estimate_fun = function(x) style_sigfig(x, digits = 4)) %>%
                          as_gt()
              # Using Beta as the name of the parameter column is weird.
              
Table_1

```
  #equation with country names

$realized_{i} = \beta_0 + \beta_1 popular_{i} + \beta_2 dissident_{i} +  \beta_3 foreign_{i} + \beta_4 military + \beta_5 rebel + \beta_6 palace_{i} + \beta_7 auto + \epsilon_{i}$ 


```{r popular resistance vs. rest1}
popular <- unique(Clean_coup$popular)
dissident <- 1
foreign <- 1
military <- 1
rebel <- 1
palace <- 1
auto <- 1


newobs_1 <- tibble(expand_grid(popular, dissident, foreign, military, rebel, 
	   palace, auto))

pe_2 <- add_fitted_draws(newobs_1, fit_2) 

pe_2 %>% 
  pivot_longer(names_to = "Coup_Method",
               values_to = "Occurance",
               cols = popular:palace) %>% 
  ggplot(aes(x = `.value`, y = Coup_Method)) +
  stat_slab()

```


```{r popular resistance vs. rest}
newobs1 <- tibble( popular = c(1,0), dissident =  1, foreign =  1,
                   military =  1, rebel = 1, palace =  1, auto =  1) %>% 
                   mutate(names = paste("popular", popular, sep = "_"))
              
                             

pe_1 <- posterior_epred(fit_2, 
                 newdata = newobs1) %>% 
                 as_tibble() %>% 
                 set_names(newobs1$names) %>% 
                 pivot_longer(names_to = "coup_type",
                           values_to = "perc_realized",
                           cols = c("popular_1", "popular_0"))


pe_1 %>% 
  ggplot(aes(x = perc_realized, color = coup_type)) +
          geom_histogram(aes(y = after_stat(count/sum(count))),
                         alpha = 0.5, 
                         bins = 100,
                         fill = "darkorchid") +
        labs(x = "Estimated Sucess of Coup",
               y = "Probability") +
          scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
          scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
          theme_classic()





```


```{r military vs rest}

fit_1 <- stan_glm(realized ~ popular + military + foreign + auto + year + country + event_type + killed,
                  family = gaussian,
                  model_data,
                  refresh = 0,
                  seed = 13)

newobsz <- tibble( popular = 1, dissident =  1, foreign =  1,
                   military =  c(1,0), rebel = 1, palace =  1, auto =  1) %>% 
                   mutate(names = paste("military", military, sep = "_"))

pe_z <- posterior_epred(fit_2, 
                 newdata = newobsz) %>% 
                 as_tibble() %>% 
                 set_names(newobsz$names) %>% 
                 pivot_longer(names_to = "coup_type",
                           values_to = "perc_realized",
                           cols = c("military_1", "military_0"))

pe_z %>% 
  ggplot(aes(x = perc_realized)) +
  stat_slab(aes(fill = coup_type),
                alpha = .5)
                   
```

```{r fit_3}
fit_3 <-   stan_glm(formula = realized ~ event_type + killed,
                         data = Clean_coup,
                         family = "binomial",
                         refresh = 0)
fit_3


event_type <- unique(Clean_coup$event_type)
killed <- unique(Clean_coup$killed)

newobs_3 <- tibble(expand_grid(event_type, killed)) 




pe_3 <- add_fitted_draws(newobs_3, fit_3) 

pe_3 %>% 
  filter(event_type != "coup") %>% 
  ggplot(aes(x = `.value`, y = event_type)) +
  stat_slab()

```